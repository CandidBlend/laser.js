// Laser.js v0.2.0, by Edward Hotchkiss <edward@candidblend.la>
// http://github.com/CandidBlend/Laser.js
(function(t,e){"use strict";function i(t){return w[t]}function s(t){return w[t]=i(t)||$(t),w[t]}function n(t){var e="000000";return(e+t).slice(-e.length)}function r(t){return $.cssEase[t]!==e?!0:!1}function a(t,e,i){var s,n;return"string"==typeof t?(n=t.match(/^(-|\+)|(=)|([0-9]+$)/g),""===i?s=t:n&&3===n.length?(e=e.replace(/deg|px/,""),"-"===n[0]?s=e-n[2]+i:"+"===n[0]&&(s=e+n[2]+i)):/^[0-9]+$/.test(t)||(s=t)):s=""+t+i,s}function o(){return _.uniqueId("laser_tr_")}function h(t){return t.replace(/-([a-z])/gi,function(t,e){return e.toUpperCase()})}function u(t){return t.charAt(0).toUpperCase()+t.slice(1)}function c(t){var e,i=h(t);return _.each(y,function(s){""===E[s+u(i)]&&(e={css:"-"+s.toLowerCase()+"-",om:s}),""===E[t.toLowerCase()]&&(e={css:"",om:""})}),e}function l(t){return{css:c(t).css+t.toLowerCase(),om:c(t).om+t}}function m(t,e,i,s){var n=f(t,e);return n[l("transition-duration").css]=d(i),n[l("transition-timing-function").css]=$.cssEase[s],n}function f(t,i,s){var n,r,o,h={};return s=null===s?!0:s,_.each(t,function(t,e){n=i[e],_.contains(v,e)?(r="perspective"===e?"px":"deg",r="scale"===e?"":r,""===o?o+=" "+e+"("+a(t,n,r)+") ":o=e+"("+a(t,n,r)+") "):(r="opacity"===e?"":"px",h[s?l(e).css:e]=a(t,n,r))}),o!==e&&(h[s?l("Transform").css:"transform"]=o),h}function d(t){return"string"!=typeof t||/^[0-9]+$/.test(t)?t/1e3+"s":t}function g(t){return/(rotate|scale)/.test(t)}var p=t.Laser=function p(e){return _.extend(this,e),this.listeners={},this.state="blank",this.animations=[],this.direction="forward",this.DEBUG=this.DEBUG||/http(s)?:\/\/(localhost:8888|[^\/]+.local|192\.168\.1\..*)\//.test(t.location),this.console="object"==typeof t.console,this},w={},T=document.createElement("div"),E=T.style,y=["","webkit","Moz","o","ms"];["webkitTransitionEnd","oTransitionEnd","otransitionend","transitionend","msTransitionEnd"].join(" ");var v=["matrix","matrix3d","translate","translate3d","translateX","translateY","translateZ","scale","scale3d","scaleX","scaleY","scaleZ","rotate","rotate3d","rotateX","rotateY","rotateZ","skew","skewX","skewY","perspective"],A=function A(t){return _.extend(this,t),this.state="ON_STACK",this.originalStyle=this.$elem.attr("data-original-style"),this.originalStyle===e&&(this.originalStyle=this.$elem.attr("style"),this.$elem.attr("data-original-style",this.originalStyle)),this};A.prototype={getCurrentParams:function(){var t={};return _.forEach(this.params,function(e,i){g(i)&&(t.transform=this.$elem.css(i)),t[i]=this.$elem.css(i)},this),t},play:function(){this.startParams=this.getCurrentParams(),this.state="PLAYING",this.active=!0,this.transition()},complete:function(){this.sequence.trigger("animation:completed",this),this.state="COMPLETED",this.active=!1},pause:function(){this.pausedStyle=this.$elem.attr("style"),_.forEach(this.getCurrentParams(),function(t,e){this.$elem.css(e,this.$elem.css(e))},this),this.$elem.removeClass(this.id),this.state="PAUSED"},resume:function(){this.$elem.addClass(this.id),_.forEach(this.getCurrentParams(),function(t,e){this.$elem.css(e,"")},this),this.completeTimeout=setTimeout(_.bind(function(){this.complete()},this),this.options.duration),this.state="PLAYING"},rewind:function(){this.$elem.addClass("rewind-shim"),this.$elem.removeClass(this.id),this.completeTimeout=setTimeout(_.bind(function(){this.complete(),this.$elem.removeClass("rewind-shim")},this),this.options.duration)},transition:function(){this.$elem.css(m(this.params,this.startParams,this.options.duration,this.options.easing)),this.completeTimeout=setTimeout(_.bind(function(){this.complete()},this),this.options.duration)}},p.prototype={elapsed:function(){return(new Date).getTime()-this.startedAt},log:function(t){if(this.console&&this.DEBUG){var e,i,s;s=this.name||"NO NAME",i=Array.prototype.slice.call(arguments),i[0]="LASER ["+n(this.elapsed())+"] > "+t+' "'+s+'"',e=Function.prototype.bind.call(console.log,console),e.apply(console,i)}},get:function(t,i){return i===e?this[t]:_.where(this[t],i)},set:function(t,i,s){var n=this.get(t,i);return n===e?e:(_.forEach(s,function(t,e){n[e]=t},this),n)},on:function(t,e){return this.listeners[t]=this.listeners[t]||[],this.listeners[t].push(e),this},off:function(t,e){return this.listeners[t]?this.listeners[t].splice(this.listeners[t].indexOf(e),1):(this.listeners={},_.isArray(this.timers)&&_.each(this.timers,function(t){clearTimeout(t)})),this},trigger:function(t){if(this.listeners[t]){var e=Array.prototype.slice.call(arguments,1);_.forEach(this.listeners[t],function(t){t.apply(this,e)},this)}return this},add:function(t,e,i){var n,a=this,h=s(t);if(n=i.when||0,i.easing=i.easing||"easeOutExpo",!r(i.easing)){if(!r("easeOutExpo"))throw Error("Unknown easing method! - "+i.easing);i.easing="easeOutExpo"}return i.duration=i.duration||500,this.animations.push(new A({id:o(),when:n,active:!1,params:e,options:i,sequence:a,selector:t,$elem:h})),this},addEasing:function(t,e){return $.cssEase[t]=e,this},onAnimated:function(){this.padTime?setTimeout(_.bind(function(){this.log("sequence completed"),this.trigger("sequence:completed")},this),this.padTime):(this.log("sequence completed"),this.trigger("sequence:completed"))},onAnimationComplete:function(){this.remaining--,0===this.remaining&&this.trigger("sequence:animated"),0>this.remaining&&t.console&&console.warn("Remaining animations count should not be below 0",this.name)},start:function(){if("paused"===this.getState())return this.resume();var t=this.get("animations");return this.startedAt=(new Date).getTime(),this.remaining=t.length,this.trigger("sequence:started",this.remaining),this.log("starting sequence"),_.forEach(t,function(t){t.whenTimeout=setTimeout(_.bind(function(){t.play()},this),t.when)},this),this.on("sequence:animated",function(){this.onAnimated(),this.log("animated sequence")}),this.on("animation:completed",function(t){this.onAnimationComplete(t)}),this.state="playing",this},wait:function(t){return this.padTime=t,this},pause:function(){return"paused"===this.getState()?this:(this.pausedAt=this.elapsed(),this.log("pausing"),_.forEach(this.get("animations"),function(t){switch(t.state){case"STOPPED":break;case"ON_STACK":t.state="ON_STACK_RESET",clearTimeout(t.whenTimeout);break;case"PLAYING":clearTimeout(t.completeTimeout),t.pause()}},this),this.trigger("sequence:paused"),this.state="paused",this)},resume:function(){var t=this.pausedAt;return this.log("resuming"),_.forEach(this.get("animations"),function(i){if(!_isTransition)return i.$elem.resume(),e;switch(i.state){case"PAUSED":i.resume();break;case"ON_STACK_RESET":i.whenTimeout=setTimeout(_.bind(function(){i.play()},this),i.when-t),this.state="ON_STACK"}},this),this.trigger("sequence:resuming"),this.state="resuming",this},rewind:function(){var t,e,i;return this.pause(),i=this.pausedAt,t=this.getRunTime(),this.log("rewinding"),e=_.map(this.get("animations"),function(e){return e.when=t-e.when-e.options.duration,e},this),e.reverse(),_.forEach(e,function(t){t.whenTimeout=setTimeout(_.bind(function(){t.rewind()},this),t.when)},this),this.direction="rewind",this.remaining=e.length,this.trigger("sequence:rewinding"),this.state="rewinding",this},getRunTime:function(){var t,e=this.get("animations");return t=e[e.length-1],t.when+t.options.duration},getState:function(){return this.state},getName:function(){return this.name},setName:function(t){return this.name=t,this}}})(window);